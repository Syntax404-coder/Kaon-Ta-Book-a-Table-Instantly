<h1>System Administration</h1>

<h2>All Reservations</h2>

<%= turbo_stream_from :reservations %>

<% if @reservations.any? %>
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Customer Name</th>
        <th>Date</th>
        <th>Time</th>
        <th>Guest Count</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="reservations">
      <%= render partial: "admin/reservations/reservation", collection: @reservations %>
    </tbody>
  </table>
<% else %>
  <p>No reservations in the system.</p>
<% end %>

<br><hr><br>

<h2>Reservation Overview (<%= @selected_date.strftime("%B %Y") %>)</h2>

<!-- Legend -->
<div style="display: flex; gap: 20px; margin-bottom: 20px; align-items: center;">
  <strong>Legend:</strong>
  <div style="display: flex; align-items: center; gap: 5px;">
    <div style="width: 20px; height: 20px; background-color: #d4edda; border: 1px solid #c3e6cb;"></div>
    <span>Low (< 5)</span>
  </div>
  <div style="display: flex; align-items: center; gap: 5px;">
    <div style="width: 20px; height: 20px; background-color: #fff3cd; border: 1px solid #ffeeba;"></div>
    <span>Moderate (5-15)</span>
  </div>
  <div style="display: flex; align-items: center; gap: 5px;">
    <div style="width: 20px; height: 20px; background-color: #f8d7da; border: 1px solid #f5c6cb;"></div>
    <span>High (> 15)</span>
  </div>
</div>

<!-- Calendar Grid -->
<div style="border: 1px solid #ddd; padding: 10px; background: #fff;">
  <% 
    start_date = @selected_date.beginning_of_month
    end_date = @selected_date.end_of_month
    # Adjust to start on Sunday/Monday
    calendar_start = start_date.beginning_of_week(:sunday)
    calendar_end = end_date.end_of_week(:sunday)
  %>
  
  <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
    <thead>
      <tr>
        <% %w[Sun Mon Tue Wed Thu Fri Sat].each do |day| %>
          <th style="padding: 10px; border: 1px solid #ddd; background: #f8f9fa;"><%= day %></th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% (calendar_start..calendar_end).each_slice(7) do |week| %>
        <tr>
          <% week.each do |day| %>
            <% 
              count = @daily_counts[day] || 0
              bg_color = if count > 15
                           "#f8d7da" # Red
                         elsif count >= 5
                           "#fff3cd" # Yellow
                         else
                           "#d4edda" # Green
                         end
              
              # Dim days not in current month
              opacity = day.month == @selected_date.month ? "1.0" : "0.4"
              border = day == @selected_date ? "3px solid #007bff" : "1px solid #ddd"
            %>
            <td style="height: 100px; padding: 0; border: <%= border %>; opacity: <%= opacity %>; vertical-align: top; background-color: <%= day.month == @selected_date.month ? bg_color : '#f8f9fa' %>;">
              <a href="<%= admin_dashboard_path(date: day) %>" style="display: block; width: 100%; height: 100%; text-decoration: none; color: inherit; padding: 10px;">
                <div style="text-align: right; font-weight: bold; margin-bottom: 10px;"><%= day.day %></div>
                <% if day.month == @selected_date.month && count > 0 %>
                  <div style="font-size: 0.85em; text-align: center;">
                    <strong><%= count %></strong><br>Reservations
                  </div>
                <% end %>
              </a>
            </td>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<br><hr><br>

<h2>Manage Time Slots (<%= @selected_date.strftime("%B %d, %Y") %>)</h2>

<!-- Admin Date Picker -->
<div style="margin-bottom: 20px; padding: 10px; background-color: #f8f9fa; border: 1px solid #ddd; display: inline-block;">
  <form action="<%= admin_dashboard_path %>" method="get" style="display: flex; gap: 10px; align-items: center;">
    <label for="date" style="font-weight: bold;">Select Date:</label>
    <input type="date" name="date" value="<%= @selected_date %>" style="padding: 5px;">
    <input type="submit" value="Go" class="btn btn-primary btn-sm">
  </form>
</div>

<% 
  breakfast = @tables.select { |t| (7..10).include?(t.start_time.hour) }
  lunch = @tables.select { |t| (11..14).include?(t.start_time.hour) }
  dinner = @tables.select { |t| (18..21).include?(t.start_time.hour) }
%>

<% if breakfast.any? %>
  <h3>Breakfast (07:00 - 10:00)</h3>
  <table border="1" style="width:100%; text-align: left; border-collapse: collapse; margin-bottom: 20px;">
    <thead><tr><th>Time</th><th>Status</th><th>Remaining Seats</th><th>Action</th></tr></thead>
    <tbody>
      <% breakfast.each do |table| %>
        <%= render partial: "admin/dashboard/time_slot_row", locals: { table: table } %>
      <% end %>
    </tbody>
  </table>
<% end %>

<% if lunch.any? %>
  <h3>Lunch (11:00 - 14:00)</h3>
  <table border="1" style="width:100%; text-align: left; border-collapse: collapse; margin-bottom: 20px;">
    <thead><tr><th>Time</th><th>Status</th><th>Remaining Seats</th><th>Action</th></tr></thead>
    <tbody>
      <% lunch.each do |table| %>
        <%= render partial: "admin/dashboard/time_slot_row", locals: { table: table } %>
      <% end %>
    </tbody>
  </table>
<% end %>

<% if dinner.any? %>
  <h3>Dinner (18:00 - 21:00)</h3>
  <table border="1" style="width:100%; text-align: left; border-collapse: collapse; margin-bottom: 20px;">
    <thead><tr><th>Time</th><th>Status</th><th>Remaining Seats</th><th>Action</th></tr></thead>
    <tbody>
      <% dinner.each do |table| %>
        <%= render partial: "admin/dashboard/time_slot_row", locals: { table: table } %>
      <% end %>
    </tbody>
  </table>
<% end %>

